# Nginx Configuration for Chrome Debugger Reverse Proxy
# Optimized for AWS EC2 Amazon Linux 2023
# Supports WebSocket connections for Chrome DevTools Protocol

user nginx; # Run nginx as the nginx user for security
worker_processes auto; # Automatically set worker processes to match CPU cores
worker_rlimit_nofile 65536; # Set file descriptor limit for worker processes
error_log /var/log/nginx/error.log; # Main error log location
pid /run/nginx.pid; # Process ID file location for service management

# Load dynamic modules
include /usr/share/nginx/modules/*.conf; # Load additional nginx modules

events {
    worker_connections 25000; # Maximum concurrent connections per worker process
    # Optimized for WebSocket connections
    use epoll; # Use epoll for efficient I/O event notification (Linux)
    multi_accept on; # Accept multiple connections simultaneously
}

http {
    # Basic Settings
    sendfile on; # Use kernel sendfile() for efficient file serving
    tcp_nopush on; # Optimize TCP packet transmission (use with sendfile)
    tcp_nodelay on; # Disable Nagle's algorithm for low latency
    keepalive_timeout 65; # Keep connections alive for 65 seconds
    types_hash_max_size 2048; # Maximum size of MIME types hash table
    
    
    # MIME Types
    include /etc/nginx/mime.types; # Load MIME type mappings
    default_type application/octet-stream; # Default MIME type for unknown files

    # Logging Configuration
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'upgrade:$http_upgrade connection:$connection_upgrade';

    access_log /var/log/nginx/access.log main; # Main access log with custom format

    # WebSocket Connection Upgrade Map
    # This maps the Connection header for proper WebSocket handling
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # Gzip Compression
    gzip on; # Enable gzip compression
    gzip_vary on; # Add Vary: Accept-Encoding header
    gzip_proxied any; # Compress responses for all proxied requests
    gzip_comp_level 6; # Compression level (1-9, 6 is optimal balance)
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Security Headers
    add_header X-Frame-Options DENY; # Prevent iframe embedding (clickjacking protection)
    add_header X-Content-Type-Options nosniff; # Prevent MIME type sniffing
    add_header X-XSS-Protection "1; mode=block"; # Enable XSS filtering in browsers

    # Buffer Settings for WebSocket and Large DevTools Messages
    proxy_buffering off; # Disable buffering for real-time communication
    proxy_buffer_size 4k; # Size of buffer for response headers
    proxy_buffers 8 4k; # Number and size of buffers for response body
    proxy_busy_buffers_size 8k; # Size limit for busy buffers

    # Timeout Settings for Long-lived WebSocket Connections
    proxy_connect_timeout 60s; # Timeout for establishing upstream connection
    proxy_send_timeout 300s; # Timeout for sending request to upstream
    proxy_read_timeout 300s; # Timeout for reading response from upstream

    # Include server configurations
    include /etc/nginx/conf.d/*.conf; # Load additional server configurations
    
    # Include Chrome debugger proxy configuration
    include /etc/nginx/sites-enabled/*; # Load enabled site configurations
}